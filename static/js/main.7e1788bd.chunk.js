(this["webpackJsonp24-hour-video"]=this["webpackJsonp24-hour-video"]||[]).push([[0],{158:function(e,t,a){},159:function(e,t,a){},180:function(e,t,a){"use strict";a.r(t);a(153);var n=a(0),r=a(37),c=a.n(r),s=(a(158),a(139)),i=a(140),o=(a(159),a(192)),d=a(10),l=a(194),h=a(41),j=a(199),u=a(108),b=a(138),m=a(27),p=a.n(m),x=a(42),O=a(106),f=function(){var e=Object(h.b)(),t=e.getAccessTokenSilently,a=e.isAuthenticated,r=Object(n.useState)(null),c=Object(O.a)(r,2),s=c[0],i=c[1];return Object(n.useEffect)((function(){a&&Object(x.a)(p.a.mark((function e(){var a;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t({audience:"https://dev-kk-pm4fd.eu.auth0.com/api/v2/",scope:"read:current_user"});case 2:a=e.sent,i(a);case 4:case"end":return e.stop()}}),e)})))()}),[a,t]),s},v=a(2),w=function(){var e=Object(h.b)(),t=e.logout,a=e.loginWithRedirect,r=e.isAuthenticated,c=e.isLoading,s=function(){var e=Object(n.useState)(null),t=Object(O.a)(e,2),a=t[0],r=t[1],c=f();return Object(n.useEffect)((function(){c&&Object(x.a)(p.a.mark((function e(){var t;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("https://jbm3qrd33k.execute-api.us-east-1.amazonaws.com/dev/user-profile",{headers:{Authorization:"Bearer ".concat(c)}});case 3:if((t=e.sent).ok){e.next=8;break}console.error("AWS error: ".concat(t.status," (").concat(t.statusText,")")),e.next=13;break;case 8:return e.t0=r,e.next=11,t.json();case 11:e.t1=e.sent,(0,e.t0)(e.t1);case 13:e.next=18;break;case 15:e.prev=15,e.t2=e.catch(0),console.error(e.t2);case 18:case"end":return e.stop()}}),e,null,[[0,15]])})))()}),[c]),a}();return c?null:r?s?Object(v.jsxs)(j.a,{as:"div",labelPosition:"left",onClick:function(){return t({returnTo:window.location.origin})},children:[Object(v.jsxs)(u.a,{basic:!0,children:[Object(v.jsx)(b.a,{avatar:!0,spaced:!0,src:s.picture,alt:s.name}),s.name]}),Object(v.jsx)(j.a,{negative:!0,children:"Log Out"})]}):null:Object(v.jsx)(j.a,{onClick:function(){return a({redirectUri:window.location.origin})},children:"Log In"})},g=a(83),y=function(){return Object(v.jsx)(o.a,{style:{marginBottom:"2em"},children:Object(v.jsxs)(l.a,{stackable:!0,borderless:!0,children:[Object(v.jsx)(l.a.Item,{as:g.a,to:"/main",replace:!0,children:"Main"}),Object(v.jsx)(l.a.Item,{as:g.a,to:"/videos",replace:!0,children:"Videos"}),Object(v.jsx)(l.a.Menu,{position:"right",children:Object(v.jsx)(l.a.Item,{children:Object(v.jsx)(w,{})})})]})})},k=a(40),S=a(82),T=a(137),I=a.n(T),A=Object(S.c)({selectId:function(e){return e.eTag},sortComparer:function(e,t){return t.date-e.date}}),W="videos",z=function(e){return e.videos},C=A.getSelectors((function(e){return z(e)}));function R(e,t){switch(e){case"filename":var a=t.match(/\d+x(\d+p)/i);return a&&(this.videoQuality=a[1].toLowerCase()),t;case"date":return Date.parse(t);default:return t}}var J=Object(S.b)("".concat(W,"/fetchAllVideos"),function(){var e=Object(x.a)(p.a.mark((function e(t,a){var n,r,c,s,i,o;return p.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.getState,r=a.rejectWithValue,c=z(n()).videoQuality,s=I()("https://jbm3qrd33k.execute-api.us-east-1.amazonaws.com/dev/videos",{queryParams:c?{encoding:c}:{}}),e.prev=3,e.next=6,fetch(s,{headers:{Authorization:"Bearer ".concat(t)}});case 6:return i=e.sent,e.next=9,i.text();case 9:if(o=e.sent,!i.ok){e.next=12;break}return e.abrupt("return",JSON.parse(o,R));case 12:return e.abrupt("return",r("HTTP ".concat(i.status,": ").concat(o)));case 15:return e.prev=15,e.t0=e.catch(3),e.abrupt("return",r(e.t0));case 18:case"end":return e.stop()}}),e,null,[[3,15]])})));return function(t,a){return e.apply(this,arguments)}}(),{condition:function(e,t){var a=t.getState;return function(e){return!e.loading&&e.doReload}(z(a()))}}),L=Object(S.d)({name:W,initialState:A.getInitialState({loading:!1,error:null,baseUrl:null,videoQuality:"",doReload:!1}),reducers:{setVideoQuality:function(e,t){t.payload!==e.videoQuality&&(e.doReload=!0,e.videoQuality=t.payload)}},extraReducers:function(e){return e.addCase(J.fulfilled,(function(e,t){A.setAll(e,t.payload.files),e.baseUrl=t.payload.baseUrl,e.doReload=!1})).addMatcher((function(e){return e.type.endsWith("/pending")}),(function(e){e.loading=!0,e.error=null})).addMatcher((function(e){return e.type.endsWith("/fulfilled")}),(function(e){e.loading=!1,e.error=null})).addMatcher((function(e){return e.type.endsWith("/rejected")}),(function(e,t){e.loading=!1,e.error=t.payload}))}}),H=L.actions.setVideoQuality,P=L.reducer,B=a(195),D=a(197),U=a(198),Q=a(193),q=function(){var e=f(),t=Object(k.b)(),a=Object(k.c)((function(e){return C.selectAll(e)})),r=Object(k.c)((function(e){return z(e).loading})),c=Object(k.c)((function(e){return z(e).error})),s=Object(k.c)((function(e){return z(e).baseUrl})),i=Object(k.c)((function(e){return z(e).videoQuality}));Object(n.useEffect)((function(){Object(x.a)(p.a.mark((function a(){return p.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:e&&t(J(e));case 1:case"end":return a.stop()}}),a)})))()}),[e,t]);if(c)return Object(v.jsx)(U.a,{error:!0,content:c});return Object(v.jsxs)(o.a,{children:[Object(v.jsx)(Q.a,{children:Object(v.jsx)(Q.a.Select,{options:[{value:"",text:"ALL"},{value:"480p",text:"480p"},{value:"720p",text:"720p"},{value:"1080p",text:"1080p"}],label:"Video quality",placeholder:"Select video quality",onChange:function(a,n){var r=n.value;t(H(r)),e&&t(J(e))},value:i})}),Object(v.jsxs)(B.a,{striped:!0,children:[Object(v.jsx)(B.a.Header,{children:Object(v.jsxs)(B.a.Row,{children:[Object(v.jsx)(B.a.HeaderCell,{width:2,children:"Date"}),Object(v.jsx)(B.a.HeaderCell,{width:2,children:"Quality"}),Object(v.jsx)(B.a.HeaderCell,{width:12,textAlign:"center",children:"Video"})]})}),Object(v.jsx)(B.a.Body,{children:r?Object(v.jsx)(B.a.Row,{children:Object(v.jsx)(B.a.Cell,{colSpan:"3",children:Object(v.jsx)(D.a,{fluid:!0,children:Object(v.jsxs)(D.a.Header,{children:[Object(v.jsx)(D.a.Line,{length:"full"}),Object(v.jsx)(D.a.Line,{length:"full"}),Object(v.jsx)(D.a.Line,{length:"full"})]})})})},"1"):a.map((function(e){return Object(v.jsxs)(B.a.Row,{verticalAlign:"top",children:[Object(v.jsx)(B.a.Cell,{children:new Date(e.date).toUTCString()}),Object(v.jsx)(B.a.Cell,{children:e.videoQuality}),Object(v.jsx)(B.a.Cell,{textAlign:"center",children:Object(v.jsxs)("video",{width:"640",height:"360",controls:!0,controlsList:"nodownload",preload:"metadata",children:[Object(v.jsx)("source",{type:"video/mp4",src:"".concat(s).concat(e.filename)}),"Your browser does not support the <video/> tag."]})})]},e.eTag)}))})]})]})},M=a(201),V=a(196),E=function(){return Object(v.jsxs)(o.a,{style:{marginTop:"2em"},children:[Object(v.jsx)(M.a,{as:"h2",dividing:!0,children:"Demo video site with AWS"}),Object(v.jsx)("p",{children:"The following features of a typical video site are demoed:"}),Object(v.jsxs)(V.a,{bulleted:!0,relaxed:!0,style:{marginTop:"2em",marginBottom:"2em"},children:[Object(v.jsx)(V.a.Item,{children:"The user must be registered and logged in to view any videos."}),Object(v.jsx)(V.a.Item,{children:"The video quality can be selected by the user, affecting the list of videos displayed."}),Object(v.jsx)(V.a.Item,{children:"The information of the logged-in user is displayed."})]}),Object(v.jsxs)("p",{children:["The application's source code lives\xa0",Object(v.jsx)("a",{href:"https://github.com/JormaStenman/24-hour-video",children:"here"}),"."]}),Object(v.jsx)(M.a,{as:"h2",dividing:!0,children:"Motivation/background"}),Object(v.jsxs)("p",{children:["I wrote this application when reading\xa0",Object(v.jsx)("a",{href:"https://www.manning.com/books/serverless-architectures-on-aws",children:"Serverless Architectures on AWS"})," and\xa0",Object(v.jsx)("a",{href:"https://www.manning.com/books/serverless-architectures-on-aws-second-edition",children:"its second edition preview"})," by Peter Sbarski and others. The app is based on the exercise project in those books. Because the preview book was still incomplete, and the code in the 2017 original is now mostly outdated, I ended up making a few changes:"]}),Object(v.jsxs)(V.a,{bulleted:!0,relaxed:!0,style:{marginTop:"2em",marginBottom:"2em"},children:[Object(v.jsx)(V.a.Item,{children:"All Javascript code is modernized."}),Object(v.jsxs)(V.a.Item,{children:["The latest\xa0",Object(v.jsx)("a",{href:"https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/index.html",children:"AWS-SDK"})," is used."]}),Object(v.jsxs)(V.a.Item,{children:["The lambda code is deployed using\xa0",Object(v.jsx)("a",{href:"https://www.serverless.com",children:"Serverless Framework"}),", instead of\xa0",Object(v.jsx)("a",{href:"https://aws.amazon.com/cli/",children:"AWS CLI"})," directly."]}),Object(v.jsxs)(V.a.Item,{children:["Even though AWS-SDK v3 allows for modular AWS dependencies, it produces huge application bundles due to many added development libraries compared to v2. To combat this, the code is minified in the build process using the\xa0",Object(v.jsx)("a",{href:"https://www.serverless.com/plugins/serverless-webpack",children:"Serverless Webpack plugin"}),"."]}),Object(v.jsxs)(V.a.Item,{children:["The website is re-designed, and implemented with\xa0",Object(v.jsx)("a",{href:"https://reactjs.org",children:"React"}),", its related technologies, and\xa0",Object(v.jsx)("a",{href:"https://react.semantic-ui.com",children:"Semantic UI"}),"."]})]}),Object(v.jsx)(M.a,{as:"h2",dividing:!0,children:"Implementation aspects"}),Object(v.jsx)("p",{children:"A few implementation details worth mentioning:"}),Object(v.jsxs)(V.a,{bulleted:!0,relaxed:!0,style:{marginTop:"2em",marginBottom:"2em"},children:[Object(v.jsx)(V.a.Item,{children:"The application consists of a website subproject and an AWS Lambda subproject."}),Object(v.jsxs)(V.a.Item,{children:[Object(v.jsx)("a",{href:"https://auth0.com",children:"Auth0"})," is used for authenticating and authorizing users. New users must register with Auth0 directly, or use their Google account."]}),Object(v.jsxs)(V.a.Item,{children:["The website accesses two of the lambda functions:",Object(v.jsxs)(V.a.List,{children:[Object(v.jsxs)(V.a.Item,{children:[Object(v.jsx)("a",{href:"https://github.com/JormaStenman/24-hour-video/blob/master/lambda/user-profile/index.js",children:"The lambda returning information about the logged-in user"}),". This is for demonstration purposes only, as the same data could be had through Auth0 directly. Also, as there are two web hops when fetching the info, the user info box in the navbar sometimes appears with a noticeable delay."]}),Object(v.jsxs)(V.a.Item,{children:[Object(v.jsx)("a",{href:"https://github.com/JormaStenman/24-hour-video/blob/master/lambda/get-video-list/index.js",children:"The lambda returning the list of videos"}),"."]})]})]}),Object(v.jsxs)(V.a.Item,{children:["Website access to the lambdas is protected by a\xa0",Object(v.jsx)("a",{href:"https://jwt.io",children:"JWT token"})," representing the logged-in user, provided by Auth0. The HTTP API is implemented using\xa0",Object(v.jsx)("a",{href:"https://aws.amazon.com/api-gateway/",children:"Amazon API Gateway"}),". The JWT checking is done in a\xa0",Object(v.jsx)("a",{href:"https://github.com/JormaStenman/24-hour-video/blob/master/lambda/custom-authorizer/index.js",children:"custom authorizer lambda function"}),". The HTTP API has a very low throttling limit to prevent\xa0",Object(v.jsx)("a",{href:"https://en.wikipedia.org/wiki/Denial-of-service_attack",children:"DOS attacks"}),"."]}),Object(v.jsxs)(V.a.Item,{children:["The video upload process is currently only accessible to me due to AWS costs. Here's how it works:",Object(v.jsxs)(V.a.List,{as:"ol",children:[Object(v.jsxs)(V.a.Item,{as:"li",value:"1.",children:["There's an upload bucket for new videos in\xa0",Object(v.jsx)("a",{href:"https://aws.amazon.com/s3",children:"Amazon S3"}),"."]}),Object(v.jsxs)(V.a.Item,{as:"li",value:"2.",children:["Once a video file is uploaded, a\xa0",Object(v.jsx)("a",{href:"https://github.com/JormaStenman/24-hour-video/blob/master/lambda/transcode-video/index.js",children:"video converter lambda"})," is notified by an event."]}),Object(v.jsx)(V.a.Item,{as:"li",value:"3.",children:"The video is converted into three formats for the web site, each written to an output S3 bucket."}),Object(v.jsxs)(V.a.Item,{as:"li",value:"4.",children:["Whenever a converted video file appears in the output bucket, a message is sent to an\xa0",Object(v.jsx)("a",{href:"https://aws.amazon.com/sns",children:"Amazon SNS"})," topic. This kicks off an email to me, and a call to a\xa0",Object(v.jsx)("a",{href:"https://github.com/JormaStenman/24-hour-video/blob/master/lambda/set-permissions/index.js",children:"lambda granting public read access to the converted video"}),"."]})]})]})]}),Object(v.jsx)(M.a,{as:"h2",dividing:!0,children:"Implementation techniques"}),Object(v.jsx)("p",{children:"The application utilizes the following techniques and libraries:"}),Object(v.jsxs)(V.a,{bulleted:!0,relaxed:!0,style:{marginTop:"2em",marginBottom:"2em"},children:[Object(v.jsxs)(V.a.Item,{children:["The initial website subproject structure was created using\xa0",Object(v.jsx)("a",{href:"https://create-react-app.dev",children:"Create React App"})," with\xa0",Object(v.jsx)("a",{href:"https://www.npmjs.com/package/cra-template-redux",children:"the Redux template"}),"."]}),Object(v.jsxs)(V.a.Item,{children:["All code is\xa0",Object(v.jsx)("a",{href:"https://www.w3schools.com/Js/js_2018.asp",children:"ECMAScript 2018"}),"."]}),Object(v.jsxs)(V.a.Item,{children:["Amazon ",Object(v.jsx)("a",{href:"https://aws.amazon.com/s3",children:"S3"}),",\xa0",Object(v.jsx)("a",{href:"https://aws.amazon.com/sns",children:"SNS"}),",\xa0",Object(v.jsx)("a",{href:"https://aws.amazon.com/mediaconvert/",children:"Elemental MediaConvert"}),",\xa0",Object(v.jsx)("a",{href:"https://aws.amazon.com/api-gateway/",children:"API Gateway"})]}),Object(v.jsx)(V.a.Item,{children:Object(v.jsx)("a",{href:"https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/index.html",children:"AWS-SDK v3"})}),Object(v.jsx)(V.a.Item,{children:Object(v.jsx)("a",{href:"https://www.serverless.com",children:"Serverless Framework"})}),Object(v.jsxs)(V.a.Item,{children:[Object(v.jsx)("a",{href:"https://www.serverless.com/plugins/serverless-webpack",children:"Serverless Webpack plugin"}),"."]}),Object(v.jsxs)(V.a.Item,{children:[Object(v.jsx)("a",{href:"https://auth0.com",children:"Auth0"})," and\xa0",Object(v.jsx)("a",{href:"https://www.npmjs.com/package/@auth0/auth0-react",children:"Auth0 SDK for React Single Page Applications"})]}),Object(v.jsxs)(V.a.Item,{children:["Application state is managed using ",Object(v.jsx)("a",{href:"https://reactjs.org/docs/hooks-intro.html",children:"React Hooks"})," and ",Object(v.jsx)("a",{href:"https://redux-toolkit.js.org",children:"Redux Toolkit"}),"."]}),Object(v.jsxs)(V.a.Item,{children:["Navigation within the application is managed by ",Object(v.jsx)("a",{href:"https://reactrouter.com",children:"React Router"}),"."]}),Object(v.jsxs)(V.a.Item,{children:["UI components come from ",Object(v.jsx)("a",{href:"https://react.semantic-ui.com",children:"Semantic UI React"})]})]}),Object(v.jsx)(M.a,{as:"h2",dividing:!0,children:"Video and image credits"}),Object(v.jsxs)("p",{children:["The demo videos used in this app are by Ruvim Miksanskiy, and were downloaded from\xa0",Object(v.jsx)("a",{href:"https://www.pexels.com/",children:"Pexels"}),"."]}),Object(v.jsx)("p",{children:'The website icon "File:Tvfilm.png" by Her Pegship is licensed under CC BY-SA 3.0'})]})},K=function(e){var t=e.component,a=Object(i.a)(e,["component"]);return Object(v.jsx)(d.b,Object(s.a)({component:Object(h.c)(t,{returnTo:a.path})},a))},_=function(){return Object(v.jsxs)(o.a,{children:[Object(v.jsx)(y,{}),Object(v.jsxs)(d.d,{children:[Object(v.jsx)(K,{component:q,path:"/videos"}),Object(v.jsx)(d.b,{path:"/main",children:Object(v.jsx)(E,{})}),Object(v.jsx)(d.b,{path:"/",children:Object(v.jsx)(d.a,{to:"/main"})})]})]})},G=Object(S.a)({reducer:{videos:P}});Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));var N=a(23),F=Object(N.b)();c.a.render(Object(v.jsx)(d.c,{history:F,children:Object(v.jsx)(h.a,{domain:"dev-kk-pm4fd.eu.auth0.com",clientId:"p7J0yqTvGO21THopTrTr7oaTyFHglUGn",redirectUri:window.location.origin,audience:"https://dev-kk-pm4fd.eu.auth0.com/api/v2/",scope:"read:current_user update:current_user_metadata",onRedirectCallback:function(e){F.replace(e&&e.returnTo||window.location.pathname)},children:Object(v.jsx)(k.a,{store:G,children:Object(v.jsx)(_,{})})})}),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}))}},[[180,1,2]]]);
//# sourceMappingURL=main.7e1788bd.chunk.js.map